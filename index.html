<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Green Guardian / حارس الأخضر</title>
<meta name="theme-color" content="#0b3f1a" />
<style>
  :root{
    --bg:#03240e; --card:#0f3e20; --accent:#2e8b3a; --accent-2:#4caf50; --muted:#b3d8b3; --danger:#c94a3d;
    --glass: rgba(255,255,255,0.02);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{background:linear-gradient(180deg,#02230c 0%, #062e14 70%);color:#eaf6ea;padding:16px;}
  .container{max-width:960px;margin:0 auto;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--card), rgba(14,56,30,0.9));box-shadow:0 6px 18px rgba(0,0,0,0.45);margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;color:var(--accent-2)}
  .lang-switch{display:flex;gap:8px;align-items:center}
  .lang-btn{padding:6px 10px;border-radius:8px;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.06);cursor:pointer}
  .lang-btn.active{background:var(--accent-2);color:#042610;border:1px solid rgba(0,0,0,0.06)}
  .badge{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#1b6b32,#0e4f21);padding:6px 12px;border-radius:20px;font-size:13px}
  .card{background:linear-gradient(180deg,var(--glass), rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.35);border-right:6px solid rgba(255,255,255,0.03)}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .sensor-title{display:flex;gap:10px;align-items:center;font-weight:700;color:var(--muted)}
  .big-number{font-size:28px;font-weight:800;color:#fff;margin-top:6px}
  .small{font-size:13px;color:var(--muted);margin-top:4px}
  .watering{display:flex;flex-direction:column;align-items:center;gap:12px;padding:8px 0}
  .circle-btn{width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid rgba(255,255,255,0.04);cursor:pointer;transition:all .18s ease}
  .circle-btn.off { background: linear-gradient(180deg,#355f45,#1f3a2a); box-shadow: 0 8px 18px rgba(0,0,0,0.4); }
  .circle-btn.off svg .drop-fill { opacity: 0; transform: scale(0.9); transition: all .15s ease; }
  .circle-btn.off svg .drop-outline { opacity: 1; transform: scale(1); transition: all .15s ease; stroke: #fff; fill: none; stroke-width:1.5 }
  .circle-btn.on { background: linear-gradient(180deg,#6ff089,#2e8b3a); box-shadow: 0 12px 30px rgba(80,255,140,0.45); transform: translateY(-2px); }
  .circle-btn.on svg .drop-fill { opacity: 1; transform: scale(1); transition: all .15s ease; fill: #05300a; }
  .circle-btn.on svg .drop-outline { opacity: 0; transform: scale(0.8); transition: all .15s ease; }
  .btn{padding:10px 14px;border-radius:8px;background:#234;color:#dfffe0;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.06)}
  .btn.off{background:#243a2e;color:#b3d8b3}
  .btn.on{background:linear-gradient(90deg,#43a047,#2e8b3a);color:#fff;box-shadow:0 6px 18px rgba(80,255,140,0.25)}
  .danger{background:var(--danger);color:#fff}
  .alert-line{padding:10px;border-radius:8px;margin-bottom:10px;font-weight:700}
  .alert-danger{background:linear-gradient(90deg,#5b0f0f,#9e2b2b);color:#fff}
  .field { display:flex; gap:8px; align-items:center; width:100%; }
  .location { font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .loc-input { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: #eaffea; direction:ltr; }
  .small-note { font-size:12px; color:var(--muted); margin-top:6px; text-align:right; }
  .map-preview { width:100%; height:280px; border-radius:10px; overflow:hidden; margin-top:10px; display:none; border:1px solid rgba(255,255,255,0.04) }
  footer{margin-top:10px;text-align:center;color:rgba(255,255,255,0.25);font-size:13px}
  @media (max-width:880px){ .grid-3{grid-template-columns:1fr} .map-preview{height:200px} .circle-btn{width:72px;height:72px} .big-number{font-size:22px} }
</style>
</head>
<body>
  <div class="container" id="app-root" dir="ltr">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="brand"><svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 2c2.8 0 5 2 6 4-1.6.2-3.5 1-5 2-1.4 1-2.5 2.5-3 4-.5-1.5-1.6-3-3-4-1.4-1-3.4-1.8-5-2 1-2 3.2-4 6-4z" fill="#9feab0"/></svg><span id="brand-text" data-i18n="brand">Green Guardian</span></div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="lang-switch" role="tablist" aria-label="Language">
          <button id="lang-en" class="lang-btn">Eng</button>
          <button id="lang-ar" class="lang-btn">عربي</button>
        </div>

        <div class="badge" id="conn-badge">
          <span id="conn-dot" style="width:10px;height:10px;border-radius:50%;background:#6b6b6b;display:inline-block;margin-left:6px"></span>
          <span id="conn-text" data-i18n="disconnected">Disconnected</span>
        </div>

        <button id="bt-btn" class="btn secondary" data-i18n="connect">Connect Bluetooth</button>
      </div>
    </header>

    <section class="row">
      <div class="grid-3">
        <div class="card soil">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="sensor-title"><svg width="26" height="26"><path d="M12 2s-4 4-4 8 1.79 8 4 12c2.21-4 4-8 4-12s-4-8-4-8z" fill="#9feab0"/></svg>
              <div style="display:flex;flex-direction:column"><div style="font-weight:700" data-i18n="soil_title">Soil Moisture</div><div class="small" data-i18n="soil_sub">Moisture %</div></div>
            </div>
            <div style="text-align:right">
              <div class="big-number" id="soil-value">--%</div>
              <div class="small" id="soil-label">--</div>
            </div>
          </div>
        </div>

        <div class="card light">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="sensor-title"><svg width="26" height="26"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="#ffd88a"/></svg>
              <div style="display:flex;flex-direction:column"><div style="font-weight:700" data-i18n="light_title">Light Level</div><div class="small" data-i18n="light_sub">Ambient</div></div>
            </div>
            <div style="text-align:right">
              <div class="big-number" id="light-value">--</div>
              <div class="small" id="light-label">--</div>
            </div>
          </div>
        </div>

        <div class="card motion">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="sensor-title"><svg width="26" height="26"><path d="M12 2a9 9 0 100 18 9 9 0 000-18z" fill="#d7e8d7"/></svg>
              <div style="display:flex;flex-direction:column"><div style="font-weight:700" data-i18n="motion_title">Motion Sensor</div><div class="small" data-i18n="motion_sub">Movement near plant</div></div>
            </div>
            <div style="text-align:right">
              <div class="big-number" id="motion-value">--</div>
              <div class="small" id="motion-label">--</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="font-weight:800;color:var(--muted)" data-i18n="controls_title">Watering & Controls</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="find-btn" class="btn secondary" data-i18n="find_robot">Find Robot</button>
          </div>
        </div>

        <div class="watering" style="margin-top:8px">
          <div class="circle-btn off" id="water-btn" title="Toggle watering">
            <svg width="36" height="36" viewBox="0 0 24 24" aria-hidden="true">
              <path class="drop-fill" d="M12 3.3s4 4.2 4 7.2a4 4 0 01-8 0c0-3 4-7.2 4-7.2z" fill="#05300a" style="opacity:0"/>
              <path class="drop-outline" d="M12 3.3s4 4.2 4 7.2a4 4 0 01-8 0c0-3 4-7.2 4-7.2z" fill="none" stroke="#fff" stroke-width="1.5" />
            </svg>
          </div>

          <div class="water-state" id="water-state" style="font-weight:700;color:#dcffd4">Idle</div>

          <div style="display:flex;gap:8px;width:100%;margin-top:6px">
            <button id="manual-btn" class="btn off" style="flex:1" data-i18n="start_watering">Start Watering</button>
            <button id="stop-btn" class="btn secondary" style="flex:0" data-i18n="stop_watering">Stop</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;width:100%">
            <input id="loc-input" class="loc-input" placeholder="Enter robot ID or lat,lon (e.g. 25.2048,55.2708)" />
            <button id="loc-input-btn" class="btn secondary" data-i18n="locate_btn">Locate</button>
          </div>

          <div class="small-note" style="width:100%;text-align:right" id="loc-help">Type a robot ID (will send WHERE:&lt;id&gt; when connected) or paste coordinates to jump to map.</div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center;width:100%">
            <div class="location" id="loc-display" data-i18n="no_location">No location</div>
          </div>

          <div class="map-preview" id="map-preview">
            <iframe id="map-iframe" src="" width="100%" height="100%" frameborder="0" style="border:0"></iframe>
          </div>
        </div>
      </div>

      <div class="card" id="insect-card" style="display:none;border-right-color:#c94a3d">
        <div style="font-weight:800;color:#ffd7d7" data-i18n="insect_title">Insect Alert</div>
        <div id="insect-msg" style="margin-top:8px;color:#fff;font-weight:700"></div>
      </div>

    </section>

    <footer style="margin-top:6px"><span data-i18n="footer">Green Guardian • demo PWA</span></footer>
  </div>

<script>
/* ------------------------
   Config & strings
   ------------------------ */
const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
const CHAR_UUID    = '0000ffe1-0000-1000-8000-00805f9b34fb';
const LOCATE_CMD_PREFIX = 'WHERE:'; // sends e.g. WHERE:robot123

const strings = {
  en: {
    brand: "Green Guardian",
    disconnected: "Disconnected",
    connect: "Connect Bluetooth",
    soil_title: "Soil Moisture",
    soil_sub: "Moisture %",
    light_title: "Light Level",
    light_sub: "Ambient",
    motion_title: "Motion Sensor",
    motion_sub: "Movement near plant",
    controls_title: "Watering & Controls",
    find_robot: "Find Robot",
    start_watering: "Start Watering",
    stop_watering: "Stop",
    locate_btn: "Locate",
    loc_help: "Type a robot ID (will send WHERE:<id>) or paste coordinates to jump to map.",
    no_location: "No location",
    insect_title: "Insect Alert",
    footer: "Green Guardian • demo PWA"
  },
  ar: {
    brand: "حارس الأخضر",
    disconnected: "غير متصل",
    connect: "اتصال بلوتوث",
    soil_title: "رطوبة التربة",
    soil_sub: "نسبة مئوية",
    light_title: "مستوى الضوء",
    light_sub: "محلي",
    motion_title: "مستشعر الحركة",
    motion_sub: "حركة حول النبات",
    controls_title: "الري و الأدوات",
    find_robot: "تحديد مكان الروبوت",
    start_watering: "ابدأ الري",
    stop_watering: "إيقاف",
    locate_btn: "اذهب",
    loc_help: "أدخل معرف الروبوت (يرسل WHERE:<id>) أو الصق إحداثيات للعرض على الخريطة.",
    no_location: "لا يوجد موقع",
    insect_title: "تنبيه الحشرات",
    footer: "حارس الأخضر • تطبيق PWA تجريبي"
  }
};

/* ------------------------
   State & refs
   ------------------------ */
let lang = (localStorage.getItem('gg_lang') || 'en');
let bleDevice = null, bleChar = null, connected = false;
let watering = false;
let last = { soil:50, light:50, motion:false, insects:0, dangerousMotion:false };

const el = id => document.getElementById(id);
const soilValEl = el('soil-value'), soilLabel = el('soil-label');
const lightValEl = el('light-value'), lightLabel = el('light-label');
const motionValEl = el('motion-value'), motionLabel = el('motion-label');
const connDot = el('conn-dot'), connText = el('conn-text');
const btBtn = el('bt-btn'), waterBtn = el('water-btn'), manualBtn = el('manual-btn'), stopBtn = el('stop-btn');
const findBtn = el('find-btn'), locInput = el('loc-input'), locInputBtn = el('loc-input-btn');
const locDisplay = el('loc-display'), mapPreview = el('map-preview'), mapIframe = el('map-iframe');
const insectCard = el('insect-card'), insectMsg = el('insect-msg');
const langEnBtn = el('lang-en'), langArBtn = el('lang-ar'), appRoot = el('app-root');
const locHelp = el('loc-help');

const clamp = (v,m,M) => Math.max(m, Math.min(M, v));
const now = () => (new Date()).getTime();
const DEBOUNCE_MS = { soil:1000*60*30, motion:1000*60*5, insects:1000*60*60 };
const lastNotified = { soil:0, motion:0, insects:0 };
function canNotify(type){ return (now() - (lastNotified[type]||0)) > (DEBOUNCE_MS[type]||0); }
function markNotified(type){ lastNotified[type] = now(); }

/* ------------------------
   i18n apply
   ------------------------ */
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(elm=>{
    const key = elm.getAttribute('data-i18n');
    elm.textContent = (strings[lang] && strings[lang][key]) ? strings[lang][key] : '';
  });
  // placeholder and helpers
  if(lang === 'ar'){
    appRoot.setAttribute('dir','rtl');
    locInput.placeholder = "أدخل معرف الروبوت أو إحداثيات lat,lon (مثال: 25.2048,55.2708)";
    langArBtn.classList.add('active'); langEnBtn.classList.remove('active');
  } else {
    appRoot.setAttribute('dir','ltr');
    locInput.placeholder = "Enter robot ID or lat,lon (e.g. 25.2048,55.2708)";
    langEnBtn.classList.add('active'); langArBtn.classList.remove('active');
  }
  locHelp.textContent = strings[lang].loc_help;
  connText.textContent = connected ? (lang==='ar' ? 'متصل' : 'Connected') : strings[lang].disconnected;
  document.title = lang === 'ar' ? 'حارس الأخضر' : 'Green Guardian';
  localStorage.setItem('gg_lang', lang);
}

/* ------------------------
   UI helpers & notify
   ------------------------ */
function showBanner(msg, kind='danger'){ const b = document.querySelector('.alert-line') || null; const banner = el('loc-display'); /* reuse */; /* quick banner using loc-display temporarily */ console.log('banner:', msg); /* keep simple */ }
function sendNotification(title, body, urgent=false){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'granted'){ try{ new Notification(title,{body,renotify:!!urgent}); if(urgent && navigator.vibrate) navigator.vibrate([300,100,300]); } catch(e){ console.warn(e); } }
  else if(Notification.permission === 'default'){ Notification.requestPermission().then(p=>{ if(p==='granted') sendNotification(title,body,urgent); }); }
}
function statusTextForSoil(n){ if(n<20) return lang==='ar' ? 'جافة — تحتاج ري' : 'Dry — needs water'; if(n<40) return lang==='ar' ? 'منخفضة' : 'Low'; if(n<70) return lang==='ar' ? 'جيدة' : 'Good'; return lang==='ar' ? 'رطبة' : 'Wet'; }
function statusTextForLight(n){ if(n<20) return lang==='ar' ? 'ضعيف جداً' : 'Very Low'; if(n<50) return lang==='ar' ? 'منخفض' : 'Low'; if(n<80) return lang==='ar' ? 'متوسط' : 'Moderate'; return lang==='ar' ? 'مشرق' : 'Bright'; }
function statusTextForMotion(flag, dm){ if(dm) return lang==='ar' ? 'حركة خطرة' : 'Dangerous movement'; return flag ? (lang==='ar' ? 'حركة' : 'Movement') : (lang==='ar' ? 'لا حركة' : 'No Motion'); }

/* ------------------------
   Update UI
   ------------------------ */
function updateUI(data = {}){
  last.soil = (typeof data.soil !== 'undefined') ? clamp(parseFloat(data.soil)||0,0,100) : last.soil;
  last.light = (typeof data.light !== 'undefined') ? clamp(parseFloat(data.light)||0,0,100) : last.light;
  last.motion = (typeof data.motion !== 'undefined') ? !!data.motion : last.motion;
  last.insects = (typeof data.insects !== 'undefined') ? parseInt(data.insects)||0 : last.insects;
  last.dangerousMotion = (typeof data.dangerousMotion !== 'undefined') ? !!data.dangerousMotion : last.dangerousMotion;

  soilValEl.textContent = (Math.round(last.soil*10)/10) + '%';
  soilLabel.textContent = statusTextForSoil(last.soil);
  lightValEl.textContent = (Math.round(last.light*10)/10) + '%';
  lightLabel.textContent = statusTextForLight(last.light);
  motionValEl.textContent = last.dangerousMotion ? '!' : (last.motion ? '•' : '—');
  motionLabel.textContent = statusTextForMotion(last.motion, last.dangerousMotion);

  connDot.style.background = connected ? '#9ef08f' : '#6b6b6b';
  connText.textContent = connected ? (lang==='ar' ? 'متصل' : 'Connected') : strings[lang].disconnected;

  if(last.insects > 0){
    insectCard.style.display = 'block';
    insectMsg.textContent = lang==='ar' ? `${last.insects} حشرة/حشرات مكتشفة — افحص النبات` : `${last.insects} insect(s) detected — inspect plant`;
  } else insectCard.style.display = 'none';

  if(watering){ waterBtn.classList.remove('off'); waterBtn.classList.add('on'); manualBtn.classList.remove('off'); manualBtn.classList.add('on'); manualBtn.textContent = lang==='ar' ? 'إيقاف الري' : 'Stop Watering'; el('water-state').textContent = lang==='ar' ? 'جاري الري' : 'Watering Active'; }
  else { waterBtn.classList.remove('on'); waterBtn.classList.add('off'); manualBtn.classList.remove('on'); manualBtn.classList.add('off'); manualBtn.textContent = lang==='ar' ? 'ابدأ الري' : 'Start Watering'; el('water-state').textContent = lang==='ar' ? 'خامل' : 'Idle'; }
}

/* ------------------------
   Alerts
   ------------------------ */
function checkAlertsAndNotify(){
  if(last.soil < 28 && canNotify('soil')){
    sendNotification(lang==='ar' ? 'حارس الأخضر — التربة جافة' : 'Green Guardian — Dry soil', lang==='ar' ? 'التربة جافة. يوصى بالري.' : 'Soil is dry. Consider watering the plant.', false);
    markNotified('soil');
  }
  if((last.dangerousMotion || last.motion) && canNotify('motion')){
    sendNotification(lang==='ar' ? 'حارس الأخضر — تم الكشف عن حركة' : 'Green Guardian — Movement', last.dangerousMotion ? (lang==='ar' ? 'حركة خطرة' : 'Dangerous motion detected') : (lang==='ar' ? 'تم الكشف عن حركة' : 'Movement detected near plant'), true);
    markNotified('motion');
  }
  if(last.insects > 0 && canNotify('insects')){
    sendNotification(lang==='ar' ? 'حارس الأخضر — حشرات مكتشفة' : 'Green Guardian — Insects detected', lang==='ar' ? `${last.insects} حشرة/حشرات — افحص النبات` : `${last.insects} insect(s) detected — inspect plant`, true);
    markNotified('insects');
  }
}

/* ------------------------
   Parse robot string
   ------------------------ */
function parseSensorString(s){
  const out = {};
  try {
    const parts = s.trim().split(';').filter(Boolean);
    for(const p of parts){
      const [k,v] = p.split(':').map(x=>x.trim());
      if(!k) continue;
      const key = k.toUpperCase();
      if(key === 'S') out.soil = parseFloat(v);
      else if(key === 'L') out.light = parseFloat(v);
      else if(key === 'M') out.motion = (v === '1' || v.toLowerCase() === 'true');
      else if(key === 'I') out.insects = parseInt(v) || 0;
      else if(key === 'DM') out.dangerousMotion = (v === '1' || v.toLowerCase() === 'true');
      else if(key === 'LAT') out.lat = parseFloat(v);
      else if(key === 'LON') out.lon = parseFloat(v);
      else if(key === 'LOC'){ const [la,lo] = v.split(',').map(x=>parseFloat(x)); if(!isNaN(la) && !isNaN(lo)){ out.lat=la; out.lon=lo; } }
    }
  } catch(e){ console.warn(e); }
  return out;
}

/* ------------------------
   Bluetooth connect/receive
   ------------------------ */
async function connectBluetooth(){
  if(!navigator.bluetooth){ alert(lang==='ar' ? 'المتصفح لا يدعم Web Bluetooth. استخدم Chrome على أندرويد.' : 'Web Bluetooth not supported. Use Chrome on Android.'); return; }
  try {
    btBtn.textContent = lang==='ar' ? 'جارٍ اختيار الجهاز...' : 'Selecting device...';
    const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [SERVICE_UUID] });
    bleDevice = device; bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    const char = await service.getCharacteristic(CHAR_UUID);
    bleChar = char;
    if(char.properties.notify){ await char.startNotifications(); char.addEventListener('characteristicvaluechanged', onCharacteristicValueChanged); }
    connected = true;
    btBtn.textContent = lang==='ar' ? 'فصل' : 'Disconnect';
    btBtn.classList.remove('secondary'); btBtn.classList.add('danger');
    updateUI({});
  } catch(e){
    console.error(e);
    btBtn.textContent = strings[lang].connect;
    alert(lang==='ar' ? 'فشل الاتصال أو تم الإلغاء.' : 'Bluetooth connection failed or cancelled.');
  }
}
function onDisconnected(){ connected = false; btBtn.textContent = strings[lang].connect; btBtn.classList.remove('danger'); btBtn.classList.add('secondary'); updateUI({}); }
function disconnectBluetooth(){ if(bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect(); connected = false; updateUI({}); }

function onCharacteristicValueChanged(evt){
  try {
    const dv = evt.target.value; let text = '';
    if(window.TextDecoder) text = new TextDecoder().decode(dv); else { for(let i=0;i<dv.byteLength;i++) text += String.fromCharCode(dv.getUint8(i)); }
    const lastLine = text.trim().split('\n').filter(Boolean).pop() || text.trim();
    const parsed = parseSensorString(lastLine);
    if(parsed.lat && parsed.lon) showLocation(parsed.lat, parsed.lon, true);
    updateUI(parsed); checkAlertsAndNotify();
  } catch(e){ console.warn(e); }
}

/* ------------------------
   Send command to robot safely
   ------------------------ */
async function sendCommandToRobot(cmd){
  if(!bleChar){ console.log('simulate send:', cmd); return; }
  try { const enc = new TextEncoder(); await bleChar.writeValue(enc.encode(cmd + '\n')); console.log('sent', cmd); } catch(e){ console.warn('BLE send failed', e); }
}

/* ------------------------
   Water controls + icon swap
   ------------------------ */
let wateringTimer = null;
function setWateringVisual(on){
  watering = !!on;
  if(watering){ waterBtn.classList.remove('off'); waterBtn.classList.add('on'); manualBtn.classList.remove('off'); manualBtn.classList.add('on'); }
  else { waterBtn.classList.remove('on'); waterBtn.classList.add('off'); manualBtn.classList.remove('on'); manualBtn.classList.add('off'); }
  if(watering){ manualBtn.textContent = lang==='ar' ? 'إيقاف الري' : 'Stop Watering'; el('water-state').textContent = lang==='ar' ? 'جاري الري' : 'Watering Active'; }
  else { manualBtn.textContent = lang==='ar' ? 'ابدأ الري' : 'Start Watering'; el('water-state').textContent = lang==='ar' ? 'خامل' : 'Idle'; }
}
function startWatering(){ if(watering) return; setWateringVisual(true); sendCommandToRobot('WATER_ON'); if(!connected){ if(wateringTimer) clearInterval(wateringTimer); let step=0; wateringTimer = setInterval(()=>{ step+=1.5; updateUI({ soil: clamp(last.soil+step,0,98), motion:false }); if(step>8){ clearInterval(wateringTimer); wateringTimer=null; } },900); } }
function stopWatering(){ if(!watering) return; setWateringVisual(false); sendCommandToRobot('WATER_OFF'); if(wateringTimer){ clearInterval(wateringTimer); wateringTimer=null; } }
function toggleWater(){ if(watering) stopWatering(); else startWatering(); }

/* ------------------------
   Location: find, device location, manual input
   ------------------------ */
let waitingForRobotLocation = false;
function getDeviceLocation(banner){
  locDisplay.textContent = lang==='ar' ? 'جاري الحصول على موقع الجهاز...' : 'Getting location...';
  if(!navigator.geolocation){ locDisplay.textContent = lang==='ar' ? 'الموقع غير مدعوم' : 'Geolocation not supported'; return; }
  navigator.geolocation.getCurrentPosition(pos=>{ showLocation(pos.coords.latitude, pos.coords.longitude, false, banner); }, err=>{ locDisplay.textContent = lang==='ar' ? 'رفض الإذن أو تعذر الحصول على الموقع' : 'Location permission denied or unavailable'; }, { enableHighAccuracy:true, timeout:8000 });
}
function findRobot(){
  locDisplay.textContent = lang==='ar' ? 'جاري تحديد المكان...' : 'Locating...';
  if(connected && bleChar){
    waitingForRobotLocation = true;
    sendCommandToRobot('LOCATE');
    setTimeout(()=>{ if(waitingForRobotLocation){ waitingForRobotLocation=false; getDeviceLocation(lang==='ar' ? 'لم يرد الروبوت — عرض موقع الجهاز' : 'No location from robot — showing device location'); } },8000);
    return;
  }
  getDeviceLocation(lang==='ar' ? 'عرض موقع جهازك' : 'Using device location');
}
function showLocation(lat, lon, fromRobot=false, banner){
  waitingForRobotLocation = false;
  const label = fromRobot ? (lang==='ar' ? 'موقع الروبوت' : 'Robot location') : (lang==='ar' ? 'موقع الجهاز' : 'Device location');
  locDisplay.innerHTML = `${label}: ${lat.toFixed(5)}, ${lon.toFixed(5)} &nbsp; <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank" style="color:#cfe;text-decoration:underline">${lang==='ar' ? 'افتح في الخرائط' : 'Open in Maps'}</a>`;
  mapIframe.src = `https://www.google.com/maps?q=${lat},${lon}&z=17&output=embed`;
  mapPreview.style.display = 'block';
  if(banner) console.log(banner);
}
function handleManualLocateInput(){
  const text = (locInput.value || '').trim();
  if(!text){ locDisplay.textContent = strings[lang].no_location; return; }
  const coordRE = /^\s*(-?\d+(?:\.\d+)?)\s*[, ]\s*(-?\d+(?:\.\d+)?)\s*$/;
  const m = text.match(coordRE);
  if(m){ const lat = parseFloat(m[1]), lon = parseFloat(m[2]); showLocation(lat, lon, false, lang==='ar' ? 'عرض الإحداثيات' : 'Showing coordinates'); return; }
  // assume robot id
  if(connected && bleChar){ waitingForRobotLocation = true; locDisplay.textContent = lang==='ar' ? `طلب موقع المعرف "${text}" إلى الروبوت...` : `Requesting location for ID "${text}"...`; sendCommandToRobot(LOCATE_CMD_PREFIX + text); setTimeout(()=>{ if(waitingForRobotLocation){ waitingForRobotLocation=false; locDisplay.textContent = lang==='ar' ? 'لم يرد الروبوت — حاول مرة أخرى' : 'No reply from robot. Try again.'; } },8000); }
  else { locDisplay.textContent = lang==='ar' ? 'غير متصل — سيتم استخدام موقع الجهاز' : 'Not connected — using device location as fallback'; getDeviceLocation(lang==='ar' ? 'عرض موقع جهازك' : 'Using device location'); }
}

/* ------------------------
   Events & simulation
   ------------------------ */
btBtn.addEventListener('click', async ()=>{ if(!connected) await connectBluetooth(); else disconnectBluetooth(); });
waterBtn.addEventListener('click', ()=>toggleWater());
manualBtn.addEventListener('click', ()=>toggleWater());
stopBtn.addEventListener('click', ()=>stopWatering());
findBtn.addEventListener('click', ()=>findRobot());
locInputBtn.addEventListener('click', ()=>handleManualLocateInput());
langEnBtn.addEventListener('click', ()=>{ lang='en'; applyI18n(); updateUI({}); });
langArBtn.addEventListener('click', ()=>{ lang='ar'; applyI18n(); updateUI({}); });

function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(elm=>{
    const key = elm.getAttribute('data-i18n');
    elm.textContent = (strings[lang] && strings[lang][key]) ? strings[lang][key] : '';
  });
  if(lang==='ar'){ appRoot.setAttribute('dir','rtl'); locInput.placeholder = "أدخل معرف الروبوت أو إحداثيات lat,lon (مثال: 25.2048,55.2708)"; langArBtn.classList.add('active'); langEnBtn.classList.remove('active'); }
  else { appRoot.setAttribute('dir','ltr'); locInput.placeholder = "Enter robot ID or lat,lon (e.g. 25.2048,55.2708)"; langEnBtn.classList.add('active'); langArBtn.classList.remove('active'); }
  locHelp.textContent = strings[lang].loc_help;
  connText.textContent = connected ? (lang==='ar' ? 'متصل' : 'Connected') : strings[lang].disconnected;
  localStorage.setItem('gg_lang', lang);
}

/* simulation when not connected */
function simulateOnce(){
  if(connected) return;
  last.soil = clamp((last.soil || 50) + (Math.random()*6 - 3), 10, 92);
  last.light = clamp((last.light || 50) + (Math.random()*8 - 4), 6, 96);
  last.motion = (Math.random() > 0.88);
  last.dangerousMotion = (Math.random() > 0.97);
  last.insects = (Math.random() > 0.985) ? Math.floor(Math.random()*3)+1 : 0;
  updateUI({}); checkAlertsAndNotify();
}

/* init */
applyI18n();
updateUI({});
setInterval(simulateOnce, 2000);
if('Notification' in window && Notification.permission === 'default') Notification.requestPermission().catch(()=>{});
if('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js').catch(()=>{ console.log('sw register failed'); });

</script>
</body>
</html>
