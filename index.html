<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Green Guardian</title>
  <meta name="theme-color" content="#0b3f1a" />
  <style>
    :root{
      --bg:#042610; --card:#0f3e20; --accent:#2e8b3a; --accent-2:#4caf50; --muted:#b3d8b3; --warn:#f0a02d; --danger:#c94a3d;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{background:linear-gradient(180deg,#03240e 0%, #072712 70%);color:#eaf6ea;padding:16px;}
    .container{max-width:560px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--card), rgba(14,56,30,0.9));box-shadow:0 6px 18px rgba(0,0,0,0.45);margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px;color:var(--accent-2)}
    .badge{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#1b6b32,#0e4f21);padding:6px 12px;border-radius:20px;font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.35);border-left:6px solid rgba(255,255,255,0.03)}
    .row{display:flex;flex-direction:column;gap:12px}
    .sensor-title{display:flex;gap:10px;align-items:center;font-weight:700;color:var(--muted)}
    .big-number{font-size:30px;font-weight:800;color:#fff;margin-top:6px}
    .small{font-size:13px;color:var(--muted);margin-top:4px}
    .card.soil{border-left-color:#6fd97a}.card.light{border-left-color:#f0a02d}.card.motion{border-left-color:#9fb3b0}
    .watering{display:flex;flex-direction:column;align-items:center;gap:12px;padding:8px 0}
    /* circle button base */
    .circle-btn{width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid rgba(255,255,255,0.04);cursor:pointer;transition:all .18s ease}
    /* OFF state */
    .circle-btn.off { background: linear-gradient(180deg,#355f45,#1f3a2a); box-shadow: 0 8px 18px rgba(0,0,0,0.4); }
    .circle-btn.off svg { fill: #ffffff; opacity: 0.95; transform: scale(1); transition: transform .18s ease, fill .18s ease; }
    .btn.off { background: #243a2e; color: #b3d8b3; transition: background .18s ease, color .18s ease; }
    /* ON state */
    .circle-btn.on { background: linear-gradient(180deg,#6ff089,#2e8b3a); box-shadow: 0 12px 30px rgba(80,255,140,0.45); transform: translateY(-2px); }
    .circle-btn.on svg { fill: #05300a; opacity: 1; transform: scale(1.05); transition: transform .18s ease, fill .18s ease; }
    .btn.on { background: linear-gradient(90deg,#43a047,#2e8b3a); color: #fff; box-shadow: 0 6px 18px rgba(80,255,140,0.25); }
    .btn{padding:10px 14px;border-radius:8px;background:#234;color:#dfffe0;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.06)}
    .danger{background:var(--danger);color:#fff}
    .alert-line{padding:10px;border-radius:8px;margin-bottom:10px;font-weight:700}
    .alert-danger{background:linear-gradient(90deg,#5b0f0f,#9e2b2b);color:#fff}
    footer{margin-top:10px;text-align:center;color:rgba(255,255,255,0.25);font-size:13px}
    @media (max-width:420px){body{padding:10px}.big-number{font-size:26px}.circle-btn{width:72px;height:72px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <svg width="26" height="26" viewBox="0 0 24 24"><path d="M12 2c2.8 0 5 2 6 4-1.6.2-3.5 1-5 2-1.4 1-2.5 2.5-3 4-.5-1.5-1.6-3-3-4-1.4-1-3.4-1.8-5-2 1-2 3.2-4 6-4z" fill="#9feab0"/></svg>
        Green Guardian
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <div id="alert-banner" style="display:none"></div>
        <div class="badge" id="conn-badge">
          <span style="width:10px;height:10px;border-radius:50%;background:#6b6b6b;display:inline-block;margin-right:6px" id="conn-dot"></span>
          <span id="conn-text">Disconnected</span>
        </div>
        <button id="bt-btn" class="btn secondary" title="Connect to robot">Connect Bluetooth</button>
      </div>
    </header>

    <section class="row">
      <div class="card soil">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="sensor-title"><svg width="26" height="26"><path d="M12 2s-4 4-4 8 1.79 8 4 12c2.21-4 4-8 4-12s-4-8-4-8z" fill="#9feab0"/></svg>
            <div style="display:flex;flex-direction:column"><div style="font-weight:700;color:#cdefd0">Soil Moisture</div><div style="font-size:12px;color:var(--muted)">Moisture %</div></div>
          </div>
          <div style="text-align:right">
            <div class="big-number" id="soil-value">--%</div>
            <div class="small" id="soil-label">--</div>
          </div>
        </div>
      </div>

      <div class="card light">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="sensor-title"><svg width="26" height="26"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="#ffd88a"/></svg>
            <div style="display:flex;flex-direction:column"><div style="font-weight:700;color:#ffe7b5">Light Level</div><div style="font-size:12px;color:var(--muted)">Ambient</div></div>
          </div>
          <div style="text-align:right">
            <div class="big-number" id="light-value">--</div>
            <div class="small" id="light-label">--</div>
          </div>
        </div>
      </div>

      <div class="card motion">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="sensor-title"><svg width="26" height="26"><path d="M12 2a9 9 0 100 18 9 9 0 000-18z" fill="#d7e8d7"/></svg>
            <div style="display:flex;flex-direction:column"><div style="font-weight:700;color:#dff7d7">Motion Sensor</div><div style="font-size:12px;color:var(--muted)">Movement near plant</div></div>
          </div>
          <div style="text-align:right">
            <div class="big-number" id="motion-value">--</div>
            <div class="small" id="motion-label">--</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800;color:var(--muted);margin-bottom:8px">Watering Control</div>
        <div class="watering">
          <!-- initial state OFF: both circle and manual button have class "off" -->
          <div class="circle-btn off" id="water-btn" title="Toggle watering">
            <!-- water drop icon (color controlled via CSS) -->
            <svg width="34" height="34" viewBox="0 0 24 24"><path d="M12 3.3s4 4.2 4 7.2a4 4 0 01-8 0c0-3 4-7.2 4-7.2z" /></svg>
          </div>
          <div class="water-state" id="water-state">Idle</div>
          <div style="display:flex;gap:8px;width:100%">
            <button id="manual-btn" class="btn off" style="flex:1">Start Watering</button>
            <button id="stop-btn" class="btn secondary" style="flex:0">Stop</button>
          </div>
        </div>
      </div>

      <div class="card" id="insect-card" style="display:none;border-left-color:#c94a3d">
        <div style="font-weight:800;color:#ffd7d7">Insect Alert</div>
        <div id="insect-msg" style="margin-top:8px;color:#fff;font-weight:700"></div>
      </div>

    </section>

    <footer>Green Guardian • demo PWA</footer>
  </div>

<script>
/* ============================
   Configuration & state
   ============================ */
/* Replace these with your robot's BLE UUIDs if needed */
const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
const CHAR_UUID    = '0000ffe1-0000-1000-8000-00805f9b34fb';

let bleDevice = null, bleChar = null, connected = false;
let watering = false;
let last = { soil: 50, light: 50, motion: false, insects: 0, dangerousMotion: false };

/* Debounce config */
const DEBOUNCE_MS = { soil: 1000 * 60 * 30, motion: 1000 * 60 * 5, insects: 1000 * 60 * 60 };
const lastNotified = { soil: 0, motion: 0, insects: 0 };

/* UI refs */
const el = id => document.getElementById(id);
const soilValEl = el('soil-value'), soilLabel = el('soil-label');
const lightValEl = el('light-value'), lightLabel = el('light-label');
const motionValEl = el('motion-value'), motionLabel = el('motion-label');
const connDot = el('conn-dot'), connText = el('conn-text'), alertBanner = el('alert-banner');
const btBtn = el('bt-btn'), waterBtn = el('water-btn'), manualBtn = el('manual-btn'), stopBtn = el('stop-btn');
const insectCard = el('insect-card'), insectMsg = el('insect-msg');

const clamp = (v,m,M) => Math.max(m, Math.min(M, v));
const now = () => (new Date()).getTime();
function canNotify(type){ return (now() - (lastNotified[type] || 0)) > (DEBOUNCE_MS[type] || 0); }
function markNotified(type){ lastNotified[type] = now(); }

function showBanner(msg, kind='danger'){
  alertBanner.style.display = 'block';
  alertBanner.className = 'alert-line ' + (kind==='danger' ? 'alert-danger' : '');
  alertBanner.textContent = msg;
  setTimeout(()=> alertBanner.style.display = 'none', 7000);
}

function sendNotification(title, body, urgent=false){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'granted'){
    try{
      new Notification(title, { body, renotify: !!urgent });
      if(urgent && navigator.vibrate) navigator.vibrate([300,100,300]);
    }catch(e){ console.warn('notify failed', e); }
  } else if(Notification.permission === 'default'){
    Notification.requestPermission().then(p => { if(p === 'granted') sendNotification(title, body, urgent); });
  }
}

/* UI helpers */
function statusTextForSoil(n){
  if(n < 20) return 'Dry — needs water';
  if(n < 40) return 'Low';
  if(n < 70) return 'Good';
  return 'Wet';
}
function statusTextForLight(n){
  if(n < 20) return 'Very Low';
  if(n < 50) return 'Low';
  if(n < 80) return 'Moderate';
  return 'Bright';
}
function statusTextForMotion(flag, dm){
  if(dm) return 'Dangerous movement';
  return flag ? 'Movement' : 'No Motion';
}

function updateUI(data = {}){
  last.soil = (typeof data.soil !== 'undefined') ? clamp(parseFloat(data.soil)||0, 0, 100) : last.soil;
  last.light = (typeof data.light !== 'undefined') ? clamp(parseFloat(data.light)||0, 0, 100) : last.light;
  last.motion = (typeof data.motion !== 'undefined') ? !!data.motion : last.motion;
  last.insects = (typeof data.insects !== 'undefined') ? parseInt(data.insects)||0 : last.insects;
  last.dangerousMotion = (typeof data.dangerousMotion !== 'undefined') ? !!data.dangerousMotion : last.dangerousMotion;

  soilValEl.textContent = (Math.round(last.soil*10)/10) + '%';
  soilLabel.textContent = statusTextForSoil(last.soil);
  lightValEl.textContent = (Math.round(last.light*10)/10) + '%';
  lightLabel.textContent = statusTextForLight(last.light);
  motionValEl.textContent = last.dangerousMotion ? '!' : (last.motion ? '•' : '—');
  motionLabel.textContent = statusTextForMotion(last.motion, last.dangerousMotion);

  connDot.style.background = connected ? '#9ef08f' : '#6b6b6b';
  connText.textContent = connected ? 'Connected' : 'Disconnected';

  if(last.insects > 0){
    insectCard.style.display = 'block';
    insectMsg.textContent = `${last.insects} insect(s) detected — inspect plant`;
  } else {
    insectCard.style.display = 'none';
  }
}

/* Alerts */
function checkAlertsAndNotify(){
  if(last.soil < 28 && canNotify('soil')){
    sendNotification('Green Guardian — Dry soil', 'Soil is dry. Consider watering the plant.', false);
    markNotified('soil'); showBanner('Soil is dry — watering recommended', 'danger');
  }
  if((last.dangerousMotion || last.motion) && canNotify('motion')){
    sendNotification('Green Guardian — Movement', last.dangerousMotion ? 'Dangerous motion detected!' : 'Movement detected near plant', true);
    markNotified('motion'); showBanner(last.dangerousMotion ? 'Dangerous movement detected — check immediately' : 'Movement detected nearby', 'danger');
  }
  if(last.insects > 0 && canNotify('insects')){
    sendNotification('Green Guardian — Insects detected', `${last.insects} possible insect(s) detected. Inspect and treat.`, true);
    markNotified('insects'); showBanner('Insects detected — inspect plant', 'danger');
  }
}

/* Parse robot messages like: S:45;L:60;M:1;I:2;DM:0 */
function parseSensorString(s){
  const out = {};
  try {
    const parts = s.trim().split(';').filter(Boolean);
    for(const p of parts){
      const [k,v] = p.split(':').map(x => x.trim());
      if(!k) continue;
      const key = k.toUpperCase();
      if(key === 'S') out.soil = parseFloat(v);
      else if(key === 'L') out.light = parseFloat(v);
      else if(key === 'M') out.motion = (v === '1' || v.toLowerCase() === 'true');
      else if(key === 'I') out.insects = parseInt(v) || 0;
      else if(key === 'DM') out.dangerousMotion = (v === '1' || v.toLowerCase() === 'true');
    }
  } catch(e){ console.warn('parseSensorString', e); }
  return out;
}

/* ---- Bluetooth ---- */
async function connectBluetooth(){
  if(!navigator.bluetooth){ alert('Web Bluetooth not supported. Use Chrome on Android.'); return; }
  try{
    btBtn.textContent = 'Selecting device...';
    const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [SERVICE_UUID] });
    bleDevice = device;
    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    const char = await service.getCharacteristic(CHAR_UUID);
    bleChar = char;
    if(char.properties.notify){ await char.startNotifications(); char.addEventListener('characteristicvaluechanged', onCharacteristicValueChanged); }
    connected = true;
    btBtn.textContent = 'Disconnect'; btBtn.classList.remove('secondary'); btBtn.classList.add('danger');
    updateConnUI(); showBanner('Connected to robot', '');
  } catch(e){ console.error('BLE connect failed', e); btBtn.textContent = 'Connect Bluetooth'; alert('Bluetooth connection failed or cancelled.'); }
}

function onDisconnected(){ connected = false; updateConnUI(); btBtn.textContent = 'Connect Bluetooth'; btBtn.classList.remove('danger'); btBtn.classList.add('secondary'); showBanner('Robot disconnected', 'danger'); }

function disconnectBluetooth(){ if(bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect(); connected = false; updateConnUI(); }

function onCharacteristicValueChanged(evt){
  try{
    const dv = evt.target.value; let text = '';
    if(window.TextDecoder) text = new TextDecoder().decode(dv); else { for(let i=0;i<dv.byteLength;i++) text += String.fromCharCode(dv.getUint8(i)); }
    const lastLine = text.trim().split('\n').filter(Boolean).pop() || text.trim();
    const parsed = parseSensorString(lastLine);
    updateUI(parsed); checkAlertsAndNotify();
  } catch(e){ console.warn('characteristic parse error', e); }
}

/* ---- Send command to robot ---- */
async function sendCommandToRobot(cmd){
  if(!bleChar){ console.log('No BLE char; simulated send:', cmd); return; }
  try{ const enc = new TextEncoder(); await bleChar.writeValue(enc.encode(cmd + '\n')); console.log('sent', cmd); } catch(e){ console.warn('BLE send failed', e); }
}

/* ---- Watering controls with UI state changes ---- */
let wateringTimer = null;

function safeSendCommand(cmd){ try{ sendCommandToRobot(cmd); } catch(e){ console.warn('safeSendCommand', e); } }

function startWatering(){
  if(watering) return;
  watering = true;
  // set ON classes
  waterBtn.classList.remove('off'); waterBtn.classList.add('on');
  manualBtn.classList.remove('off'); manualBtn.classList.add('on');
  manualBtn.textContent = 'Stop Watering'; document.getElementById('water-state').textContent = 'Watering Active';
  safeSendCommand('WATER_ON'); showBanner('Watering started', '');
  manualBtn.disabled = true; setTimeout(()=>manualBtn.disabled = false, 700);

  // simulate soil rise when disconnected
  if(!connected){
    if(wateringTimer) clearInterval(wateringTimer);
    let step = 0;
    wateringTimer = setInterval(()=>{
      step += 1.5;
      const newSoil = clamp(last.soil + step, 0, 98);
      updateUI({ soil: newSoil, motion: false });
      if(step > 8){ clearInterval(wateringTimer); wateringTimer = null; }
    }, 900);
  }
}

function stopWatering(){
  if(!watering) return;
  watering = false;
  // set OFF classes
  waterBtn.classList.remove('on'); waterBtn.classList.add('off');
  manualBtn.classList.remove('on'); manualBtn.classList.add('off');
  manualBtn.textContent = 'Start Watering'; document.getElementById('water-state').textContent = 'Idle';
  safeSendCommand('WATER_OFF'); showBanner('Watering stopped', '');
  if(wateringTimer){ clearInterval(wateringTimer); wateringTimer = null; }
}

function toggleWater(){ if(watering) stopWatering(); else startWatering(); }

/* ---- Events and simulation ---- */
btBtn.addEventListener('click', async ()=>{ if(!connected) await connectBluetooth(); else disconnectBluetooth(); });
waterBtn.addEventListener('click', ()=>toggleWater());
manualBtn.addEventListener('click', ()=>toggleWater());
stopBtn.addEventListener('click', ()=>stopWatering());

function updateConnUI(){ connDot.style.background = connected ? '#9ef08f' : '#6b6b6b'; connText.textContent = connected ? 'Connected' : 'Disconnected'; }

function simulateOnce(){
  if(connected) return;
  last.soil = clamp((last.soil || 50) + (Math.random()*6 - 3), 10, 92);
  last.light = clamp((last.light || 50) + (Math.random()*8 - 4), 6, 96);
  last.motion = (Math.random() > 0.88);
  last.dangerousMotion = (Math.random() > 0.97);
  last.insects = (Math.random() > 0.985) ? Math.floor(Math.random()*3)+1 : 0;
  updateUI({}); checkAlertsAndNotify();
}

/* Initialize UI & simulation */
updateUI({ soil: last.soil, light: last.light, motion: last.motion, insects: last.insects });
setInterval(simulateOnce, 2000);

/* Notifications permission & SW */
if('Notification' in window && Notification.permission === 'default') Notification.requestPermission().catch(()=>{});
if('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js').catch(()=>{ console.log('sw register failed'); });
</script>
</body>
</html>
